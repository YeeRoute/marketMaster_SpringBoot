<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" th:replace="~{body/head :: head}">
  <title>可兌換商品列表</title>

  <!-- CSS 引用 -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    .product-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
    }

    .status-active {
      color: #198754;
      font-weight: 500;
    }

    .status-inactive {
      color: #dc3545;
      font-weight: 500;
    }

    .btn-action {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
      margin: 0 2px;
    }

    .card {
      background: #fff;
      margin-bottom: 30px;
      border: 0;
      border-radius: .55rem;
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 10%);
    }

    .card-header {
      padding: 1rem 1.35rem;
      margin-bottom: 0;
      background-color: #4e73df;
      border-bottom: 1px solid rgba(33, 40, 50, 0.125);
      color: white;
    }

    .table-hover tbody tr:hover {
      background-color: rgba(78, 115, 223, 0.05);
    }

    /* DataTables 客製化樣式 */
    .dataTables_wrapper .dataTables_length select {
      border: 1px solid #e3e6f0;
      border-radius: 4px;
      padding: 0.375rem 1.75rem 0.375rem 0.75rem;
    }

    .dataTables_wrapper .dataTables_filter input {
      border: 1px solid #e3e6f0;
      border-radius: 4px;
      padding: 0.375rem 0.75rem;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
      background: #4e73df !important;
      color: white !important;
      border: 1px solid #4e73df;
    }

    .badge.bg-info {
      background-color: #36b9cc !important;
    }
  </style>
</head>

<body>
<div th:replace="~{body/header :: header}">
  <div th:fragment="content">
    <div class="container-fluid">
      <h1 class="h3 mb-2 text-gray-800">兌換商品管理列表</h1>
      <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
          <h6 class="m-0 font-weight-bold text-white">
            <i class="fas fa-gift me-2"></i>商品列表
          </h6>
          <div class="dropdown no-arrow">
            <button class="btn btn-success btn-sm" onclick="showAddModal()">
              <i class="fas fa-plus"></i>新增商品
            </button>
          </div>
        </div>

        <div class="card-body">
          <!-- 錯誤訊息顯示 -->
          <div id="errorMessage" class="alert alert-danger" style="display:none;"></div>

          <div class="table-responsive">
            <table id="itemTable" class="table table-bordered table-hover" width="100%" cellspacing="0">
              <thead>
              <tr>
                <th>商品圖片</th>
                <th>商品編號</th>
                <th>商品名稱</th>
                <th>商品類別</th>
                <th>兌換點數</th>
                <th>可兌換數量</th>
                <th>開始日期</th>
                <th>結束日期</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
              </thead>
              <tbody>
              <!-- 空的tbody，由 DataTable 填充 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 新增商品模態框 -->
    <div class="modal fade" id="addModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">新增兌換商品</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="addItemForm">
              <div class="mb-3">
                <label class="form-label">商品ID</label>
                <input type="text" class="form-control" name="itemId" required>
              </div>
              <div class="mb-3">
                <label class="form-label">商品名稱</label>
                <select class="form-select" name="productId" required>
                  <option value="">請選擇商品</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">兌換點數</label>
                <input type="number" class="form-control" name="itemPoints" required min="1">
              </div>
              <div class="mb-3">
                <label class="form-label">可兌換數量</label>
                <input type="number" class="form-control" name="itemMaximum" required min="1">
              </div>
              <div class="mb-3">
                <label class="form-label">開始日期</label>
                <input type="date" class="form-control" name="startDate" required>
              </div>
              <div class="mb-3">
                <label class="form-label">結束日期</label>
                <input type="date" class="form-control" name="endDate" required>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" onclick="addItem()">確定新增</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 編輯商品模態框 -->
    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">編輯兌換商品</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editItemForm">
              <input type="hidden" name="itemId">
              <div class="mb-3">
                <label class="form-label">商品名稱</label>
                <select class="form-select" name="productId" required>
                  <option value="">請選擇商品</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">兌換點數</label>
                <input type="number" class="form-control" name="itemPoints" required min="1">
              </div>
              <div class="mb-3">
                <label class="form-label">可兌換數量</label>
                <input type="number" class="form-control" name="itemMaximum" required min="1">
              </div>
              <div class="mb-3">
                <label class="form-label">開始日期</label>
                <input type="date" class="form-control" name="startDate" required>
              </div>
              <div class="mb-3">
                <label class="form-label">結束日期</label>
                <input type="date" class="form-control" name="endDate" required>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" name="active">
                  <label class="form-check-label">啟用狀態</label>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" onclick="updateItem()">確定修改</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
  let dataTable;
  //這段要套進來。中文化
  // $(document).ready(function() {
  //     var table = $('#checkoutsTable').DataTable({
  //         "language": {
  //             "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Chinese-traditional.json"
  //         }
  //     });


  $(document).ready(function () {
    // 檢查是否已經初始化
    if (!$.fn.DataTable.isDataTable('#itemTable')) {
      initializeDataTable();
      loadProducts();
    }
  });
  // 初始化 DataTable
  function initializeDataTable() {
    try {
      // 新的 DataTable 初始化 - 修改 API 路徑並添加日期狀態邏輯
      dataTable = $('#itemTable').DataTable({
        ajax: {
          url: '/marketMaster/itemManagement/api/list', // 修改: API 路徑統一化
          dataSrc: 'data',  // 修改: 統一數據源格式
          error: function (xhr, error) {
            console.error('AJAX 錯誤:', error);
            $('#errorMessage').text('數據載入失敗：' + error).show();
          }
        },
        processing: true,
        responsive: true,
        dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
        order: [],
        columns: [
          {
            data: 'productPhoto',
            render: function (data) {
              return data
                      ? `<img src="data:image/jpeg;base64,${data}" class="product-img" alt="商品圖片">`
                      : '<span class="text-muted"><i class="fas fa-image"></i> 無圖片</span>';
            },
            orderable: false,
            className: 'align-middle'
          },
          {data: 'itemId', className: 'align-middle'},
          {data: 'productName', className: 'align-middle'},
          {data: 'productCategory', className: 'align-middle'},
          {
            data: 'itemPoints',
            render: function (data) {
              return `<span class="badge bg-info">${data.toLocaleString()} 點</span>`;
            },
            className: 'align-middle'
          },
          {
            data: 'itemMaximum',
            render: function (data) {
              return `<span class="fw-bold">${data.toLocaleString()}</span> 個`;
            },
            className: 'align-middle'
          },
          {
            data: 'startDate',
            render: function (data) {
              return new Date(data).toLocaleDateString('zh-TW');
            },
            className: 'align-middle'
          },
          {
            data: 'endDate',
            render: function (data) {
              return new Date(data).toLocaleDateString('zh-TW');
            },
            className: 'align-middle'
          },
          {
            data: 'active',
            render: function (data, type, row) {
              const today = new Date();
              const startDate = new Date(row.startDate);
              const endDate = new Date(row.endDate);
              // 將 `data` 顯示在控制台，以幫助排查問題
              console.log('active:', data, 'StartDate:', row.startDate, 'EndDate:', row.endDate);
              let status;
              if (today < startDate) {
                status = '<span class="badge bg-warning">兌換未開始</span>';
              } else if (today > endDate) {
                status = '<span class="badge bg-secondary">兌換過期</span>';
              } else if (data) {
                status = '<span class="badge bg-success">可兌換</span>';
              } else {
                status = '<span class="badge bg-danger">兌換商品停用</span>';
              }
              return status;
            },
            className: 'align-middle'
          },
          {
            data: null,
            render: function (data) {
              return `
                <div class="btn-group" role="group">
                    <button class="btn btn-primary btn-action"
                            onclick="showEditModal('${data.itemId}')"
                            title="編輯商品">
                        <i class="fas fa-edit"></i>
                    </button>
                   <button class="btn btn-${data.active ? 'danger' : 'success'} btn-action"
                            onclick="toggleStatus('${data.itemId}', ${data.active})"
                            title="${data.active ? '停用' : '啟用'}商品">
                        <i class="fas fa-${data.active ? 'ban' : 'check'}"></i>
                    </button>
                    <button class="btn btn-danger btn-action"
                    onclick="deleteItem('${data.itemId}')"
                    title="刪除商品">
            <i class="fas fa-trash"></i>
        </button>
                </div>
            `;
            },
            orderable: false,
            className: 'align-middle text-center'
          }
        ],
        language: {
          processing: "處理中...",
          loadingRecords: "載入中...",
          lengthMenu: "顯示 _MENU_ 筆資料",
          zeroRecords: "沒有符合的資料",
          info: "顯示第 _START_ 至 _END_ 筆資料，共 _TOTAL_ 筆",
          infoEmpty: "顯示第 0 至 0 筆資料，共 0 筆",
          infoFiltered: "(從 _MAX_ 筆資料中過濾)",
          search: '<i class="fas fa-search"></i> 搜尋:',
          paginate: {
            first: '<i class="fas fa-angle-double-left"></i>',
            previous: '<i class="fas fa-angle-left"></i>',
            next: '<i class="fas fa-angle-right"></i>',
            last: '<i class="fas fa-angle-double-right"></i>'
          }
        },
      });
      // 添加 Bootstrap 類別到 DataTables 元素
      $('.dataTables_wrapper .dataTables_filter input').addClass('form-control form-control-sm');
      $('.dataTables_wrapper .dataTables_length select').addClass('form-select form-select-sm');

      // 綁定重繪事件
      dataTable.on('draw', function () {
        try {
          // 每次重繪時重新添加樣式
          $('.dataTables_wrapper .dataTables_filter input').addClass('form-control form-control-sm');
          $('.dataTables_wrapper .dataTables_length select').addClass('form-select form-select-sm');
        } catch (error) {
          console.error('表格重繪錯誤:', error);
          $('#errorMessage').text('表格重繪失敗：' + error.message).show();
        }
      });
    } catch (error) {
      console.error('DataTable 初始化錯誤:', error);
      $('#errorMessage')
              .text('表格初始化失敗：' + error.message)
              .show();
    }
  }

  // 載入商品選項
  async function loadProducts() {
    try {
      const response = await fetch('/marketMaster/product/api/list');
      const products = await response.json();
      let options = '<option value="">請選擇商品</option>';
      products.forEach(product => {
        options += `<option value="${product.productId}">${product.productName}</option>`;
      });
      $('select[name="productId"]').html(options);
    } catch (error) {
      showError('載入商品列表失敗：' + error.message);
    }
  }

  function showAddModal() {
    resetForm('#addItemForm');
    setMinDates();
    $('#addModal').modal('show');
  }

  async function showEditModal(itemId) {
    try {
      const response = await fetch(`/marketMaster/itemManagement/api/item/${itemId}`);
      const result = await response.json();

      if (result.success) {
        fillForm('#editItemForm', result.data);
        setMinDates();
        $('#editModal').modal('show');
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      showError('載入商品資料失敗：' + error.message);
    }
  }

  //表單處理函數
  function getFormData(formSelector) {
    const form = $(formSelector);
    const data = {};
    form.serializeArray().forEach(item => {
      data[item.name] = item.value;
    });
    form.find('input[type="checkbox"]').each(function () {
      data[this.name] = this.checked;
    });
    return data;
  }

  function fillForm(formSelector, data) {
    const form = $(formSelector);
    Object.keys(data).forEach(key => {
      const input = form.find(`[name="${key}"]`);
      if (input.attr('type') === 'checkbox') {
        input.prop('checked', data[key]);
      } else if (input.is('select')) {
        input.val(data[key]).trigger('change');
      } else if (input.attr('type') === 'date') {
        input.val(formatDateForInput(data[key]));
      } else {
        input.val(data[key]);
      }
    });
  }

  function resetForm(formSelector) {
    $(formSelector)[0].reset();
  }

  //日期處理函數
  function setMinDates() {
    const today = new Date().toISOString().split('T')[0];
    $('input[type="date"]').attr('min', today);
  }

  function formatDateForInput(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toISOString().split('T')[0];
  }

  //表單驗證
  function validateForm(formData) {
    if (!formData.productId) {
      throw new Error('請選擇商品');
    }
    if (formData.itemPoints <= 0) {
      throw new Error('兌換點數必須大於0');
    }
    if (formData.itemMaximum <= 0) {
      throw new Error('可兌換數量必須大於0');
    }
    if (!formData.startDate || !formData.endDate) {
      throw new Error('請設置活動日期');
    }
    if (new Date(formData.startDate) > new Date(formData.endDate)) {
      throw new Error('開始日期不能晚於結束日期');
    }
  }

  // 新增商品
  async function addItem() {
    try {
      // 獲取表單數據
      const formData =
              getFormData('#addItemForm');
      validateForm(formData);

      const response = await fetch('/marketMaster/itemManagement/api/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      });

      const result = await response.json();
      if (result.success) {
        $('#addModal').modal('hide');
        dataTable.ajax.reload();
        showSuccess('商品新增成功');
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      showError('新增失敗：' + error.message);
    }
  }

  // 修改商品
  async function updateItem(itemId) {
    try {
      const formData =
              getFormData('#editItemForm');
      validateForm(formData);

      const response = await fetch(`/marketMaster/itemManagement/api/update/${itemId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      });

      const result = await response.json();
      if (result.success) {
        $('#editModal').modal('hide');
        dataTable.ajax.reload();
        showSuccess('商品更新成功');
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      showError('更新失敗：' + error.message);
    }
  }


  // 刪除商品
  async function deleteItem(itemId) {
    if (!confirm('確定要刪除此商品？')) { return; }
    try {
      const response = await fetch(`/marketMaster/itemManagement/api/delete/${itemId}`, {
        method: 'DELETE'
      });
      const result = await response.json();
      if (result.success) {
        dataTable.ajax.reload();
        showSuccess('商品刪除成功');
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      showError('刪除失敗：' + error.message);
    }
  }

  // 切換商品狀態
  async function toggleStatus(itemId, currentStatus) {
    try {
      const action = currentStatus ? '停用' : '啟用';
      if (confirm(`確定要${action}此商品嗎？`)) {
        const response = await fetch(`/marketMaster/itemManagement/api/toggleStatus/${itemId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({active: !currentStatus})
        });

        if (!response.ok) {
          throw new Error(`操作失敗: ${response.statusText}`);
        }

        const result = await response.json();
        if (result.success) {
          dataTable.ajax.reload();
          showSuccess(`商品已成功${action}`);
        } else {
          throw new Error(result.message || '操作失敗');
        }
      }
    } catch (error) {
      console.error('切換狀態時發生錯誤:', error);
      showError('切換狀態失敗：' + error.message);
    }
  }

  // 顯示錯誤訊息
  function showError(message) {
    const errorDiv = $('#errorMessage');
    errorDiv.removeClass('alert-success')
            .addClass('alert-danger')
            .html(`<i class="fas fa-exclamation-circle me-2"></i>${message}`)
            .show();
    setTimeout(() => {
      errorDiv.hide();
    }, 3000);
  }

  // 顯示成功訊息
  function showSuccess(message) {
    const errorDiv = $('#errorMessage');
    errorDiv.removeClass('alert-danger')
            .addClass('alert-success')
            .html(`<i class="fas fa-check-circle me-2"></i>${message}`)
            .show();
    setTimeout(() => {
      errorDiv.hide();
    }, 3000);
  }
</script>
</body>
</html></title>
</head>
<body>

</body>
</html>