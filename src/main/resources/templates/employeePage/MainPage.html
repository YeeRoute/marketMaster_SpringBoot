<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:align-items="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8" th:replace="~{body/headEmployee :: head}">
    <title>main</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.css" rel="stylesheet">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding-top: 80px;
            /* Header height */
            padding-left: 65px;
            /* Shift left by another 50px from previous 130px */
            background-color: #FFF3E0;
            box-sizing: border-box;
        }

        .container {
            display: grid;
            grid-template-columns: 40% 30% 30%; /* 調整左欄、中欄、右欄寬度 */
            gap: 13px;
            padding: 10px;
            height: 100vh;
        }

        /* 左欄 */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .calendar {
            height: 70%;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
        }

        .leave-status {
            height: 25%;
            background-color: #FFF3E0;
            padding: 10px;
            border-radius: 8px;
        }

        /* 中欄 */
        .middle-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .pending-restock {
            height: 60%;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            overflow-y: auto;
        }

        .checkout-buttons {
            height: 35%;
            background-color: #FFF3E0;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* 右欄 */
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .restock-excel-buttons {
            height: 60%;
            background-color: #FFF3E0;
            padding: 10px;
            border-radius: 8px;
        }

        .member-button {
            height: 35%;
            background-color: #FFF3E0;
            padding: 10px;
            border-radius: 8px;
        }

        /* 通用按鈕樣式 */
        .btn-custom {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
        }

        /* 查詢會員區域的樣式 */
        .query-member-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .phone-input {
            flex: 1;
            padding: 8px;
        }

        .query-btn {
            white-space: nowrap;
            padding: 8px 15px;
        }

        /* 日期選擇器樣式 */
        .date-picker {
            margin: 15px 0;
        }

        .date-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .form-control {
            width: 100%;
            padding: 8px;
        }

        /* 錯誤訊息樣式 */
        .error-message {
            color: red;
            margin-top: 10px;
        }
        
        /* 圖片樣式 */
        .restock-excel-buttons img {
            width: 50px; /* 設定圖片寬度為50px */
            height: auto;
            object-fit: contain;
            align-self: center; /* 圖片居中 */
        }
    </style>
</head>

<body>
    <div th:replace="~{body/headerEmployee :: headerEmployee}">
        <div th:fragment="content">
            <div class="container">
                <div class="left-column">
                    <!-- 左上：排班月曆 -->
                    <div class="calendar">
                        <div id="calendar"></div>
                    </div>

                    <!-- 左下：請假單狀態與請假按鈕 -->
                    <div class="leave-status">
                        <p>請假單狀態：<span id="leave-status-text">待審核</span></p>
                        <button class="btn btn-warning btn-custom"><i class="fa-solid fa-champagne-glasses"></i> 請假</button>
                    </div>
                </div>

                <!-- 中上：待進貨 -->
                <div class="middle-column">
                    <div class="pending-restock">
                        <h3>待進貨項目</h3>
                        <p>項目 1</p>
                        <p>項目 2</p>
                        <!-- 添加更多項目以測試滾動 -->
                    </div>

                    <!-- 中下：結帳按鈕、退貨按鈕與查詢會員紅利按鈕 -->
                    <div class="checkout-buttons">
                        <button  id="addCart" class="btn btn-primary btn-custom"><i class="fa-solid fa-cart-shopping"></i> 結帳</button>
                        <button  id="addReturn" class="btn btn-danger btn-custom"><i class="fa-solid fa-face-flushed"></i> 退貨</button>
                    </div>
                </div>

                <!-- 右上：進貨單按鈕與匯出 Excel 按鈕 -->
                <div class="right-column">
                    <div class="restock-excel-buttons">
                        <!-- 進貨單按鈕 -->
                        <button id="addRestock" class="btn btn-success btn-custom"><img th:src="@{/img/購物車.png}" alt="無法顯示"> 新增進貨單</button>
                        <!-- 日期選擇器 -->
                        <div class="date-picker">
                            <label>選擇日期範圍：</label>
                            <div class="date-inputs">
                                <div>
                                    <label for="start-date">開始日期：</label>
                                    <input type="date" id="start-date" class="form-control">
                                </div>
                                <div>
                                    <label for="end-date">結束日期：</label>
                                    <input type="date" id="end-date" class="form-control">
                                </div>
                            </div>
                        </div>
                        <!-- 匯出 Excel 按鈕 -->
                        <button id="exportExcel" class="btn btn-info btn-custom"><img th:src="@{/img/下載.png}" alt="無法顯示2"> 匯出進貨明細Excel</button>
                    </div>

                    <!-- 右下：會員按鈕 -->
                    <div class="member-button">
                        <button id="cusList" class="btn btn-secondary btn-custom"><i class="fa-solid fa-image-portrait"></i> 會員</button>
                        <!-- 查詢會員紅利 -->
                        <input type="tel" id="customerPhone" class="phone-input" placeholder="請輸入會員手機號碼"
                            pattern="[0-9]{10}" maxlength="10">
                        <button id="queryCustomer" class="query-btn" onclick="queryCustomerBonus()">
                        	<i class="fa-solid fa-magnifying-glass"></i> 查詢會員
                        </button>
                        <div id="errorMsg" class="error-message"></div>
                        <button id="cusBonus" class="btn btn-secondary btn-custom"><i class="fa-brands fa-product-hunt"></i> 紅利紀錄</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');

            var today = new Date();
            var startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            var endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: ''
                },
                validRange: {
                    start: startOfMonth,
                    end: new Date(endOfMonth.getFullYear(), endOfMonth.getMonth(), endOfMonth.getDate() + 1)
                },
                height: '100%', /* 調整為填滿容器 */
                aspectRatio: 1.5,
                themeSystem: 'bootstrap',
                eventColor: '#0d6efd',
                eventTextColor: '#ffffff',
                editable: false,
                eventLimit: false
            });
            calendar.render();

            var prevButton = document.querySelector('.fc-prev-button');
            var nextButton = document.querySelector('.fc-next-button');

            if (prevButton) {
                prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevButton.disabled = true;
                prevButton.style.pointerEvents = 'none';
                prevButton.style.color = '#6c757d';
                prevButton.title = '無法切換到前一個月份';
            }

            if (nextButton) {
                nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextButton.disabled = true;
                nextButton.style.pointerEvents = 'none';
                nextButton.style.color = '#6c757d';
                nextButton.title = '無法切換到下一個月份';
            }
        });

        document.getElementById('addRestock').addEventListener('click', function () {
            window.location.href = "/marketMaster/restock/restockEmpInsert"
        });
        
        document.getElementById('addCart').addEventListener('click', function () {
            window.location.href = "/marketMaster/front/cart"
        });
        
        document.getElementById('addReturn').addEventListener('click', function () {
            window.location.href = "/marketMaster/front/returnProduct/add"
        });

        document.getElementById('exportExcel').addEventListener('click', function () {
            var startDate = document.getElementById('start-date').value;
            var endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                alert('請選擇匯出的開始日期和結束日期。');
                return;
            }

            if (startDate > endDate) {
                alert('開始日期不能晚於結束日期。');
                return;
            }

            console.log('匯出 Excel 的日期範圍:', startDate, '至', endDate);
            axios.get('/marketMaster/restockDetail/getExcelByDateRange', {
                params: {
                    startDate: startDate,
                    endDate: endDate
                },
                responseType: 'blob'
            }).then(res => {
                const blob = new Blob([res.data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');

                a.href = downloadUrl;
                a.download = `進貨明細_${startDate}_至_${endDate}.xlsx`; // 設置下載的文件名
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // 釋放 URL 物件
                window.URL.revokeObjectURL(downloadUrl);

            }).catch(error => {
                console.error('匯出失敗', error);
                alert('匯出失敗，請檢查日期範圍並重試。');
            })
        });

        document.getElementById('cusList').addEventListener('click', function () {
            window.location.href = "/marketMaster/customer/front/cusList"
        });

        function queryCustomerBonus() {
            const phoneNumber = document.getElementById('customerPhone').value;
            if (!phoneNumber) {
                showError('請輸入手機號碼');
                return;
            }

            if (!/^[0-9]{10}$/.test(phoneNumber)) {
                showError('請輸入正確的手機號碼格式');
                return;
            }

            // 使用 FCustomerController 的 API 進行查詢
            fetch(`/marketMaster/customer/front/details?customerTel=${phoneNumber}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('查無此會員');
                    }
                    window.location.href = `/marketMaster/customer/front/details?customerTel=${phoneNumber}`;
                })
                .catch(error => {
                    showError(error.message);
                });
        }

        function showError(message) {
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 3000);
        }
    </script>
</body>

</html>